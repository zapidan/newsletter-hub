name: Deploy to GitHub Pages

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["main", "develop", "workflow"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

  # Runs after test suite completes (for test dashboard updates)
  workflow_run:
    workflows: ["Test Suite"]
    types: [completed]

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Job to detect changes and set up matrix
  changes:
    runs-on: ubuntu-latest
    outputs:
      src: ${{ steps.changes.outputs.src }}
      tests: ${{ steps.changes.outputs.tests }}
      deps: ${{ steps.changes.outputs.deps }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            src:
              - 'src/**'
              - 'public/**'
              - '*.config.*'
              - 'tsconfig*.json'
            tests:
              - 'src/**/*.{test,spec}.{js,ts,jsx,tsx}'
              - 'src/__tests__/**'
              - 'playwright.config.ts'
              - 'vitest.config.ts'
            deps:
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'package-lock.json'

  # Build job
  build:
    runs-on: ubuntu-latest
    needs: changes
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && (needs.changes.outputs.src == 'true' || needs.changes.outputs.tests == 'true' || needs.changes.outputs.deps == 'true')) ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && (needs.changes.outputs.src == 'true' || needs.changes.outputs.tests == 'true' || needs.changes.outputs.deps == 'true'))
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Log workflow trigger
        run: |
          echo "Workflow triggered by: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            echo "Triggering workflow: ${{ github.event.workflow_run.name }}"
            echo "Workflow conclusion: ${{ github.event.workflow_run.conclusion }}"
          fi
      
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: '8'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: |
          echo "Attempting frozen install..."
          pnpm install --frozen-lockfile || {
            echo "Frozen install failed, updating lockfile..."
            pnpm install --no-frozen-lockfile
          }
      
      - name: Build main application
        if: github.event_name != 'workflow_run' && (needs.changes.outputs.src == 'true' || github.event_name == 'workflow_dispatch')
        run: pnpm build
        env:
          NODE_ENV: production
      
      - name: Check if test workflow succeeded
        if: github.event_name == 'workflow_run'
        id: test-workflow-status
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
            echo "✅ Test workflow succeeded, proceeding with artifact processing"
            echo "should_process_artifacts=true" >> $GITHUB_OUTPUT
          else
            echo "⚠️ Test workflow failed or was cancelled, skipping artifact processing"
            echo "should_process_artifacts=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Download test artifacts (if available)
        if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'
        uses: actions/download-artifact@v4
        with:
          name: test-artifacts
          path: ./
        continue-on-error: true
      
      - name: Check test artifacts
        id: check-artifacts
        run: |
          echo "Checking for test artifacts..."
          echo "Event type: ${{ github.event_name }}"
          
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            echo "Test workflow conclusion: ${{ github.event.workflow_run.conclusion }}"
            echo "Should process artifacts: ${{ steps.test-workflow-status.outputs.should_process_artifacts }}"
            
            # If test workflow failed, don't expect artifacts
            if [ "${{ steps.test-workflow-status.outputs.should_process_artifacts }}" == "false" ]; then
              echo "⚠️ Test workflow failed, creating minimal test data"
              echo "found_artifacts=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          else
            echo "Direct push event - checking for existing artifacts"
          fi
          
          ls -la test-results/ 2>/dev/null || echo "test-results directory not found"
          ls -la html/ 2>/dev/null || echo "html directory not found"
          
          if [ -f "test-results/junit.xml" ]; then
            echo "✅ Test artifacts found"
            echo "found_artifacts=true" >> $GITHUB_OUTPUT
          else
            echo "⚠️ No test artifacts found, will create minimal test data"
            echo "found_artifacts=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create fallback test data
        if: steps.check-artifacts.outputs.found_artifacts == 'false'
        run: |
          echo "Creating fallback test data..."
          mkdir -p test-results
          mkdir -p html
          mkdir -p test-dashboard
          
          # Create minimal test results
          echo '<?xml version="1.0" encoding="UTF-8"?><testsuites><testsuite name="No Tests Run" tests="0" failures="0" errors="0" skipped="0" time="0"></testsuite></testsuites>' > test-results/junit.xml
          
          # Create minimal coverage report
          echo '<html><head><title>Coverage Report - No Data Available</title><style>body{font-family:Arial,sans-serif;margin:40px}.container{max-width:800px;margin:0 auto}.warning{background:#fff3cd;border:1px solid #ffeaa7;padding:20px;border-radius:5px}</style></head><body><div class="container"><h1>Coverage Report</h1><div class="warning"><h2>⚠️ No Coverage Data Available</h2><p>Test coverage data was not found.</p></div></div></body></html>' > html/index.html
          
          # Create minimal dashboard
          echo '<html><head><title>Test Dashboard - No Data Available</title><style>body{font-family:Arial,sans-serif;margin:40px}.container{max-width:800px;margin:0 auto}.warning{background:#fff3cd;border:1px solid #ffeaa7;padding:20px;border-radius:5px}</style></head><body><div class="container"><h1>Test Dashboard</h1><div class="warning"><h2>⚠️ No Test Data Available</h2><p>Test artifacts were not found.</p></div></div></body></html>' > test-dashboard/index.html
        continue-on-error: true
      
      - name: Ensure all directories exist and have content
        run: |
          echo "Ensuring all required directories exist..."
          
          # Create directories if they don't exist
          mkdir -p test-results
          mkdir -p test-dashboard
          mkdir -p html
          mkdir -p docs/testing
          
          # Ensure test-results has content
          if [ ! -f "test-results/junit.xml" ]; then
            echo "Creating minimal test results..."
            echo '<?xml version="1.0" encoding="UTF-8"?><testsuites><testsuite name="No Tests Run" tests="0" failures="0" errors="0" skipped="0" time="0"></testsuite></testsuites>' > test-results/junit.xml
          fi
          
          # Ensure html has content
          if [ ! -f "html/index.html" ]; then
            echo "Creating minimal coverage report..."
            echo '<html><head><title>Coverage Report - No Data Available</title><style>body{font-family:Arial,sans-serif;margin:40px}.container{max-width:800px;margin:0 auto}.warning{background:#fff3cd;border:1px solid #ffeaa7;padding:20px;border-radius:5px}</style></head><body><div class="container"><h1>Coverage Report</h1><div class="warning"><h2>⚠️ No Coverage Data Available</h2><p>Test coverage data was not found.</p></div></div></body></html>' > html/index.html
          fi
          
          # Ensure test-dashboard has content
          if [ ! -f "test-dashboard/index.html" ]; then
            echo "Creating minimal dashboard..."
            echo '<html><head><title>Test Dashboard - No Data Available</title><style>body{font-family:Arial,sans-serif;margin:40px}.container{max-width:800px;margin:0 auto}.warning{background:#fff3cd;border:1px solid #ffeaa7;padding:20px;border-radius:5px}</style></head><body><div class="container"><h1>Test Dashboard</h1><div class="warning"><h2>⚠️ No Test Data Available</h2><p>Test artifacts were not found.</p></div></div></body></html>' > test-dashboard/index.html
          fi
          
          # Ensure docs/testing has content
          if [ ! -f "docs/testing/README.md" ]; then
            echo "Creating minimal docs/testing content..."
            echo '# Testing Documentation\n\nThis directory contains testing documentation and reports.\n\n## Available Reports\n\n- Test Results: `/test-results/`\n- Coverage Reports: `/html/`\n- Test Dashboard: `/test-dashboard/`' > docs/testing/README.md
          fi
          
          echo "Directory contents:"
          ls -la test-dashboard/ || echo "test-dashboard empty"
          ls -la test-results/ || echo "test-results empty"
          ls -la html/ || echo "html empty"
          ls -la docs/testing/ || echo "docs/testing empty"
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: |
            dist/
            test-results/
            test-dashboard/
            html/
            docs/testing/
            index.html
            public/

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4 